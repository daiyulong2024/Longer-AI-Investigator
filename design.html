<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>实验配置中心 - Longer AI Investigator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxyZWN0IHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgcng9IjE2IiBmaWxsPSIjMTM2ZGVjIi8+CiAgICA8cGF0aCBkPSJNMzIgMTJDMjIuMDYgMTIgMTQgMjAuMDYgMTQgMzBDMTQgMzkuOTQgMjIuMDYgNDggMzIgNDhDMzQuNSA0OCAzNi45IDQ3LjQgMzkgNDYuM0w0NCA1MFY0My4yQzQ3LjYgNDAuMiA1MCAzNS40IDUwIDMwQzUwIDIwLjA2IDQxLjk0IDEyIDMyIDEyWk0zMiA0NEMyNC4yNyA0NCAxOCAzNy43MyAxOCAzMEMxOCAyMi4yNyAyNC4yNyAxNiAzMiAxNkMzOS43MyAxNiA0NiAyMi4yNyA0NiAzMEM0NiAzNy43MyAzOS43MyA0NCAzMiA0NFoiIGZpbGw9IndoaXRlIi8+CiAgICA8cGF0aCBkPSJNMzIgMjBDMjYuNDggMjAgMjIgMjQuNDggMjIgMzBIMjZDMjYgMjYuNjkgMjguNjkgMjQgMzIgMjRDMzUuMzEgMjQgMzggMjYuNjkgMzggMzBDMzggMzEuNjYgMzcuMzQgMzMuMTYgMzYuMjkgMzQuMjJMMzQuMTIgMzYuMzlDMzIuOCAzNy43MSAzMiAzOS41MiAzMiA0MS41VjQySDM2VjQxLjVDMzYgNDAuNTcgMzYuMzcgMzkuNzEgMzYuOTcgMzkuMTFMMzkuMTIgMzYuOTZDNDAuOTEgMzUuMTcgNDIgMzIuNyA0MiAzMEM0MiAyNC40OCAzNy41MiAyMCAzMiAyMFoiIGZpbGw9IndoaXRlIi8+CiAgICA8Y2lyY2xlIGN4PSIzNCIgY3k9IjQ1IiByPSIyLjUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#136dec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101822",
                    },
                    fontFamily: {
                        "display": ["Manrope", "Noto Sans", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.375rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white font-display overflow-hidden">
<div class="flex h-screen w-full bg-background-light dark:bg-background-dark">
    <!-- Sidebar -->
    <div class="w-64 flex-shrink-0 flex flex-col bg-white dark:bg-[#1a202c] border-r border-[#e5e7eb] dark:border-[#2d3748] h-full">
        <div class="p-6 border-b border-[#f0f2f4] dark:border-[#2d3748]">
            <a href="index.html" class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined filled">science</span>
                </div>
                <div>
                    <h1 class="text-base font-bold text-[#111418] dark:text-white leading-tight">Longer AI</h1>
                    <p class="text-xs text-[#617289] dark:text-[#94a3b8] font-medium">Investigator Platform</p>
                </div>
            </a>
        </div>
        <div class="flex-1 overflow-y-auto py-6 px-4 flex flex-col gap-1">
            <a href="#section-persona" class="group flex items-center gap-3 px-3 py-3 rounded-lg bg-primary/10 border-l-4 border-primary cursor-pointer hover:bg-primary/20 transition-colors">
                <span class="material-symbols-outlined filled text-primary">person</span>
                <div class="flex flex-col"><span class="text-sm font-bold">1. 角色设定</span></div>
            </a>
            <div class="ml-6 h-4 border-l border-[#e5e7eb] dark:border-[#4a5568]"></div>
            <a href="#section-scenario" class="group flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 border-l-4 border-transparent cursor-pointer hover:border-gray-300 transition-colors">
                <span class="material-symbols-outlined text-gray-400">landscape</span>
                <div class="flex flex-col"><span class="text-sm font-medium text-gray-500">2. 场景预设</span></div>
            </a>
            <div class="ml-6 h-4 border-l border-[#e5e7eb] dark:border-[#4a5568]"></div>
            <a href="#section-options" class="group flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 border-l-4 border-transparent cursor-pointer hover:border-gray-300 transition-colors">
                <span class="material-symbols-outlined text-gray-400">quiz</span>
                <div class="flex flex-col"><span class="text-sm font-medium text-gray-500">3. 问卷与选项</span></div>
            </a>
            <div class="ml-6 h-4 border-l border-[#e5e7eb] dark:border-[#4a5568]"></div>
            <a href="#section-params" class="group flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 border-l-4 border-transparent cursor-pointer hover:border-gray-300 transition-colors">
                <span class="material-symbols-outlined text-gray-400">tune</span>
                <div class="flex flex-col"><span class="text-sm font-medium text-gray-500">4. 执行参数</span></div>
            </a>
        </div>
    </div>
    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        <div class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark pb-32">
            <div class="max-w-[960px] mx-auto px-8 py-10">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-3xl font-extrabold text-[#111418] dark:text-white">实验配置中心</h1>
                        <p class="text-[#617289] dark:text-[#94a3b8] mt-1">Design your social experiment scenario.</p>
                    </div>
                </div>

                <!-- Form -->
                <form id="design-form">
                    <!-- Section 1 -->
                    <section id="section-persona" class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-[#e5e7eb] mb-6 p-6">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary">person</span> 角色设定</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-sm font-medium mb-2">实验名称</label>
                                <input name="experimentName" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary/20" placeholder="为本次实验起个名字" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">角色名称</label>
                                <input name="personaName" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary/20" placeholder="例如：中学生"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">行为逻辑</label>
                                <select name="behaviorLogic" class="w-full px-4 py-3 rounded-lg border border-gray-200">
                                    <option>理性分析</option>
                                    <option>情感驱动</option>
                                    <option>随机游走</option>
                                    <option>从众心理</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium mb-2">背景故事</label>
                                <textarea name="backgroundStory" class="w-full px-4 py-3 rounded-lg border border-gray-200 min-h-[100px]" placeholder="描述角色背景..."></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- Section 2 -->
                    <section id="section-scenario" class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-[#e5e7eb] mb-6 p-6">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-purple-600">landscape</span> 场景预设</h2>
                        <textarea name="scenarioDescription" class="w-full px-4 py-3 rounded-lg border border-gray-200 min-h-[150px]" placeholder="描述场景..."></textarea>
                    </section>
                    
                    <!-- Section 3 -->
                    <section id="section-options" class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-[#e5e7eb] mb-6 p-6">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-orange-600">quiz</span> 问卷与选项</h2>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">核心问题</label>
                            <input name="coreQuestion" class="w-full px-4 py-3 rounded-lg border border-gray-200" placeholder="例如：你会怎么做？"/>
                        </div>
                        <div id="options-container" class="flex flex-col gap-3">
                            <!-- Options will be here -->
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500">A</div>
                                <input name="option_A" class="flex-1 px-4 py-2 rounded-lg border border-gray-200" placeholder="选项 A"/>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500">B</div>
                                <input name="option_B" class="flex-1 px-4 py-2 rounded-lg border border-gray-200" placeholder="选项 B"/>
                            </div>
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500">C</div>
                                <input name="option_C" class="flex-1 px-4 py-2 rounded-lg border border-gray-200" placeholder="选项 C (可选)"/>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-3">
                            <button type="button" onclick="addOption()" class="flex items-center gap-1 text-primary font-bold text-sm hover:underline">
                                <span class="material-symbols-outlined text-lg">add</span> 添加选项
                            </button>
                            <button type="button" onclick="removeOption()" class="flex items-center gap-1 text-red-500 font-bold text-sm hover:underline">
                                <span class="material-symbols-outlined text-lg">remove</span> 减少选项
                            </button>
                        </div>
                    </section>

                    <!-- Section 4 -->
                    <section id="section-params" class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-[#e5e7eb] mb-6 p-6">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-teal-600">tune</span> 执行参数</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">AI 实例数量 (>=1)</label>
                                <input name="instanceCount" type="number" min="1" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary/20" placeholder="例如：50"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">并行线程数 (>=1)</label>
                                <input name="concurrentLimit" type="number" min="1" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary/20" placeholder="例如：10 (建议值)"/>
                                <p class="text-xs text-gray-500 mt-1">设置并行执行的并发量（1 = 串行）</p>
                            </div>
                        </div>
                    </section>
                </form>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="absolute bottom-0 w-full bg-white dark:bg-[#1a202c] border-t border-[#e5e7eb] px-8 py-4 z-10 flex justify-between items-center shadow-lg">
             <div class="text-sm text-gray-500">Ready to run simulation.</div>
             <button onclick="handleRun()" class="px-6 py-3 rounded-lg bg-primary text-white font-bold hover:bg-blue-700 shadow-lg flex items-center gap-2">
                <span class="material-symbols-outlined">play_arrow</span> 运行实验
            </button>
        </div>
    </div>
</div>
<script src="js/templates.js"></script>
<script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const template = params.get('template');
            const id = params.get('id');

            // 1. 使用 templates.js 中的共享模板 (ROLE_TEMPLATES)
            const TEMPLATES = window.ROLE_TEMPLATES || {};

            // 2. 填充表单函数
            function populateForm(data) {
                if(!data) return;
                const form = document.getElementById('design-form');
                if(data.experimentName) form.querySelector('[name=experimentName]').value = data.experimentName;
                if(data.personaName) form.querySelector('[name=personaName]').value = data.personaName;
                if(data.behaviorLogic) form.querySelector('[name=behaviorLogic]').value = data.behaviorLogic;
                if(data.backgroundStory) form.querySelector('[name=backgroundStory]').value = data.backgroundStory;
                if(data.scenarioDescription) form.querySelector('[name=scenarioDescription]').value = data.scenarioDescription;
                if(data.coreQuestion) form.querySelector('[name=coreQuestion]').value = data.coreQuestion;
                
                // 选项 - 基于数据重建 UI
                const container = document.getElementById('options-container');
                container.innerHTML = ''; // 清除默认输入框

                // 确定选项来源 (扁平属性如 option_A 或 options 数组)
                let optionsList = [];
                if(data.options && Array.isArray(data.options)) {
                     optionsList = data.options;
                } else {
                     // 尝试 option_A, option_B...
                     const keys = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
                     keys.forEach(k => {
                         if(data[`option_${k}`]) {
                             optionsList.push({key: k, text: data[`option_${k}`]});
                         }
                     });
                }
                
                // 如果没有选项，默认为 A, B, C 空
                if(optionsList.length === 0) {
                     optionsList = [{key:'A', text:''}, {key:'B', text:''}, {key:'C', text:''}];
                }

                // 渲染
                optionsList.forEach(opt => {
                    addOptionUI(opt.key, opt.text);
                });
                
                // 参数
                if(data.instanceCount) {
                    form.querySelector('[name=instanceCount]').value = data.instanceCount;
                }
                if(data.concurrentLimit) {
                    form.querySelector('[name=concurrentLimit]').value = data.concurrentLimit;
                } else if(data.isParallel !== undefined) {
                    // 向后兼容：旧版使用布尔值
                     form.querySelector('[name=concurrentLimit]').value = data.isParallel ? 10 : 1;
                }
            }

            // 3. 逻辑
            if (id) {
                // 编辑模式
                const exp = getExperiment(id);
                if (exp) {
                    // 扁平化配置以进行填充
                    const flatData = { ...exp.config };
                    flatData.experimentName = exp.config.experimentName; // 显式赋值
                    populateForm(flatData);
                }
            } else if (template && TEMPLATES[template]) {
                // 模板模式
                populateForm(TEMPLATES[template]);
            }
            // 否则：默认清理 (HTML 已经是干净的)
        });

    function addOptionUI(key, value = '') {
        const container = document.getElementById('options-container');
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3';
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500">${key}</div>
            <input name="option_${key}" class="flex-1 px-4 py-2 rounded-lg border border-gray-200" placeholder="选项 ${key}" value="${value}"/>
        `;
        container.appendChild(div);
    }

    function addOption() {
        const container = document.getElementById('options-container');
        const currentCount = container.children.length;
        if (currentCount >= 26) {
            alert("最多支持 26 个选项 (A-Z)");
            return;
        }
        const nextKey = String.fromCharCode(65 + currentCount); // 字母 A 的 ASCII 码为 65
        addOptionUI(nextKey);
    }

    function removeOption() {
        const container = document.getElementById('options-container');
        const currentCount = container.children.length;
        if (currentCount <= 2) {
            alert("至少需要保留 2 个选项");
            return;
        }
        container.removeChild(container.lastElementChild);
    }

    function handleRun() {
        const form = document.getElementById('design-form');
        const formData = new FormData(form);
        const config = {};
        
        // 手动提取，因为 FormData 结构各异
        config.experimentName = form.querySelector('[name=experimentName]').value;
        config.personaName = form.querySelector('[name=personaName]').value;
        config.behaviorLogic = form.querySelector('[name=behaviorLogic]').value;
        config.backgroundStory = form.querySelector('[name=backgroundStory]').value;
        config.scenarioDescription = form.querySelector('[name=scenarioDescription]').value;
        config.coreQuestion = form.querySelector('[name=coreQuestion]').value;
        config.instanceCount = parseInt(form.querySelector('[name=instanceCount]').value) || 50; // 默认为空？或者提示？用户说 >=1。
        config.concurrentLimit = parseInt(form.querySelector('[name=concurrentLimit]').value) || 10;
        
        if (config.instanceCount < 1) {
            alert("实例数量必须 >= 1");
            return;
        }
        if (config.concurrentLimit < 1) {
            alert("并行线程数必须 >= 1");
            return;
        }
        
        // 提取选项
        config.options = [];
        const optionInputs = form.querySelectorAll('input[name^="option_"]');
        optionInputs.forEach(input => {
             if(input.value.trim()) {
                 config.options.push({
                     key: input.name.split('_')[1],
                     text: input.value
                 });
             }
        });
        
        if(config.options.length < 2) {
            alert("请至少设置两个选项");
            return;
        }

        const expId = createExperiment(config);
        window.location.href = `monitor.html?id=${expId}`;
    }
</script>
</body>
</html>
