<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Longer AI Investigator - Statistical Report</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxyZWN0IHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgcng9IjE2IiBmaWxsPSIjMTM2ZGVjIi8+CiAgICA8cGF0aCBkPSJNMzIgMTJDMjIuMDYgMTIgMTQgMjAuMDYgMTQgMzBDMTQgMzkuOTQgMjIuMDYgNDggMzIgNDhDMzQuNSA0OCAzNi45IDQ3LjQgMzkgNDYuM0w0NCA1MFY0My4yQzQ3LjYgNDAuMiA1MCAzNS40IDUwIDMwQzUwIDIwLjA2IDQxLjk0IDEyIDMyIDEyWk0zMiA0NEMyNC4yNyA0NCAxOCAzNy43MyAxOCAzMEMxOCAyMi4yNyAyNC4yNyAxNiAzMiAxNkMzOS43MyAxNiA0NiAyMi4yNyA0NiAzMEM0NiAzNy43MyAzOS43MyA0NCAzMiA0NFoiIGZpbGw9IndoaXRlIi8+CiAgICA8cGF0aCBkPSJNMzIgMjBDMjYuNDggMjAgMjIgMjQuNDggMjIgMzBIMjZDMjYgMjYuNjkgMjguNjkgMjQgMzIgMjRDMzUuMzEgMjQgMzggMjYuNjkgMzggMzBDMzggMzEuNjYgMzcuMzQgMzMuMTYgMzYuMjkgMzQuMjJMMzQuMTIgMzYuMzlDMzIuOCAzNy43MSAzMiAzOS41MiAzMiA0MS41VjQySDM2VjQxLjVDMzYgNDAuNTcgMzYuMzcgMzkuNzEgMzYuOTcgMzkuMTFMMzkuMTIgMzYuOTZDNDAuOTEgMzUuMTcgNDIgMzIuNyA0MiAzMEM0MiAyNC40OCAzNy41MiAyMCAzMiAyMFoiIGZpbGw9IndoaXRlIi8+CiAgICA8Y2lyY2xlIGN4PSIzNCIgY3k9IjQ1IiByPSIyLjUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&amp;family=Noto+Sans+SC:wght@100..900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#136dec",
              "background-light": "#f6f7f8",
              "background-dark": "#101822",
              "surface-light": "#ffffff",
              "surface-dark": "#1a222d",
            },
            fontFamily: {
              "display": ["Manrope", "Noto Sans SC", "sans-serif"],
            },
            borderRadius: { "DEFAULT": "0.375rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
          },
        },
      }
    </script>
<style>
    body { font-family: 'Manrope', 'Noto Sans SC', sans-serif; }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white transition-colors duration-200">
<div class="relative flex min-h-screen w-full flex-col">
<!-- Navigation -->
<header class="sticky top-0 z-50 w-full border-b border-slate-200 dark:border-slate-800 bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur">
    <div class="flex h-16 items-center justify-between px-4 md:px-10 max-w-[1400px] mx-auto w-full">
        <a href="index.html" class="flex items-center gap-4">
            <div class="flex size-8 items-center justify-center rounded-lg bg-primary/10 text-primary">
                <span class="material-symbols-outlined filled">science</span>
            </div>
            <h2 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white hidden sm:block">Longer AI Investigator</h2>
        </a>
        <nav class="hidden md:flex flex-1 justify-center gap-8">
            <a class="text-sm font-medium text-slate-500 hover:text-primary transition-colors" href="index.html">仪表盘</a>
            <a class="text-sm font-medium text-slate-500 hover:text-primary transition-colors" href="roles.html">实验管理</a>
            <a class="text-sm font-bold text-primary dark:text-primary" href="#">统计报告</a>
        </nav>
    </div>
</header>
<!-- Main Content -->
<main class="flex-1 px-4 py-8 md:px-10 md:py-10">
    <div class="mx-auto flex max-w-[1200px] flex-col gap-8">
        <!-- Page Header -->
        <div class="flex flex-wrap items-end justify-between gap-4 border-b border-slate-200 dark:border-slate-800 pb-6">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2 text-primary font-medium text-sm">
                    <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                    <a href="index.html">返回实验列表</a>
                </div>
                <h1 class="font-display text-3xl font-bold tracking-tight text-slate-900 dark:text-white md:text-4xl">专业统计报告</h1>
                <p class="text-slate-500 dark:text-slate-400 text-base">
                    实验项目：<span id="exp-name" class="font-medium text-slate-700 dark:text-slate-200">Loading...</span>
                </p>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-export" class="flex items-center gap-2 rounded-lg border border-slate-200 dark:border-slate-700 px-4 py-2 text-sm font-medium hover:bg-slate-50 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">download</span> 导出
                </button>
            </div>
        </div>
        <!-- Metrics -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
            <div class="flex flex-col justify-between rounded-xl border border-slate-200 bg-surface-light p-6 shadow-sm">
                <p class="text-sm font-medium text-slate-500">样本总数</p>
                <span id="metric-total" class="text-3xl font-bold text-slate-900 mt-4">0</span>
            </div>
            <div class="flex flex-col justify-between rounded-xl border border-slate-200 bg-surface-light p-6 shadow-sm">
                 <p class="text-sm font-medium text-slate-500">平均响应时间</p>
                 <span id="metric-time" class="text-3xl font-bold text-slate-900 mt-4">0ms</span>
            </div>
            <div class="flex flex-col justify-between rounded-xl border border-slate-200 bg-surface-light p-6 shadow-sm">
                 <p class="text-sm font-medium text-slate-500">主要倾向</p>
                 <span id="metric-top" class="text-3xl font-bold text-primary mt-4">-</span>
            </div>
        </div>
        <!-- Chart -->
        <div class="rounded-xl border border-slate-200 bg-surface-light p-6 shadow-sm">
            <h3 class="text-lg font-bold text-slate-900 mb-8">AI 选项分布</h3>
            <div id="chart-container" class="flex h-[320px] w-full items-end justify-between gap-4 px-4 pb-4 border-b border-gray-100">
                <!-- Bars dynamically injected -->
            </div>
        </div>
        <!-- Table -->
        <div class="rounded-xl border border-slate-200 bg-surface-light shadow-sm overflow-hidden">
            <div class="border-b border-slate-200 px-6 py-4 bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-900">详细记录</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500">
                        <tr>
                            <th class="px-6 py-3 font-medium">Agent ID</th>
                            <th class="px-6 py-3 font-medium cursor-pointer hover:bg-slate-100 transition-colors select-none" onclick="handleSort('option')">
                                <div class="flex items-center gap-1">
                                    选择
                                    <span class="material-symbols-outlined text-[16px] text-slate-400" id="sort-icon-option">unfold_more</span>
                                </div>
                            </th>
                            <th class="px-6 py-3 font-medium w-1/2">推理</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
             <div class="p-4 text-center text-xs text-gray-400">Showing first 100 records for performance</div>
        </div>
    </div>
</main>
</div>
<script src="js/app.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const id = getQueryParam('id');
        if (!id) return;
        
        // Bind Export Button
        const exportBtn = document.getElementById('btn-export');
        if(exportBtn) {
            exportBtn.onclick = () => exportExperiment(id);
        }

        const exp = getExperiment(id);
        if (!exp) return;
        
        document.getElementById('exp-name').innerText = exp.config.personaName;
        document.getElementById('metric-total').innerText = exp.stats.total;
        
        const avgTime = exp.stats.times.length ? (exp.stats.times.reduce((a,b)=>a+b,0) / exp.stats.times.length).toFixed(0) : 0;
        document.getElementById('metric-time').innerText = avgTime + 'ms';
        
        let maxOpt = '';
        let maxVal = -1;
        for(const [k, v] of Object.entries(exp.stats.options)){
            if(v > maxVal) { maxVal = v; maxOpt = k; }
        }
        document.getElementById('metric-top').innerText = `Option ${maxOpt}`;
        
        // Chart
        const chartContainer = document.getElementById('chart-container');
        let chartHtml = '';
        const options = exp.config.options;
        const total = exp.stats.total || 1;
        
        options.forEach(opt => {
             const count = exp.stats.options[opt.key] || 0;
             const percent = Math.round((count / total) * 100);
             const height = Math.max(percent, 5); // min height
             const isWinner = opt.key === maxOpt;
             const colorClass = isWinner ? 'bg-primary' : 'bg-slate-200';
             
             chartHtml += `
             <div class="group relative flex h-full flex-1 flex-col justify-end gap-2">
                <div class="relative flex w-full flex-col justify-end overflow-hidden rounded-t-lg bg-slate-50 transition-all hover:bg-slate-100" style="height: 100%;">
                    <div class="w-full ${colorClass} transition-all duration-500 relative" style="height: ${height}%;">
                         <div class="absolute -top-8 w-full text-center text-xs font-bold text-slate-600">${percent}%</div>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-lg font-bold text-slate-900">${opt.key}</p>
                    <p class="text-xs font-medium text-slate-500 truncate w-full px-1" title="${opt.text}">${opt.text.substring(0, 10)}...</p>
                </div>
            </div>
             `;
        });
        chartContainer.innerHTML = chartHtml;
        
        // Table Logic
        let currentLogs = exp.logs.slice(-100).reverse(); // Default view
        let sortDir = 0; // 0: none, 1: asc, -1: desc
        
        window.renderTable = function(logs) {
            const tbody = document.getElementById('table-body');
            let tableHtml = '';
            logs.forEach(log => {
                 tableHtml += `
                 <tr class="hover:bg-slate-50">
                    <td class="px-6 py-3 font-mono text-xs">${log.agentId}</td>
                    <td class="px-6 py-3"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold">Option ${log.option}</span></td>
                    <td class="px-6 py-3 text-slate-600 truncate max-w-xs" title="${log.reasoning}">${log.reasoning}</td>
                 </tr>
                 `;
            });
            tbody.innerHTML = tableHtml;
        };

        window.handleSort = function(field) {
            const icon = document.getElementById(`sort-icon-${field}`);
            
            // Toggle direction
            if (sortDir === 0 || sortDir === -1) sortDir = 1;
            else sortDir = -1;
            
            // Update Icon
            if (sortDir === 1) icon.innerText = 'keyboard_arrow_up';
            else icon.innerText = 'keyboard_arrow_down';
            icon.classList.add('text-primary');
            icon.classList.remove('text-slate-400');

            // Sort
            const sorted = [...currentLogs].sort((a, b) => {
                if (a[field] < b[field]) return -1 * sortDir;
                if (a[field] > b[field]) return 1 * sortDir;
                return 0;
            });
            
            renderTable(sorted);
        }
        
        // Initial Render
        renderTable(currentLogs);
    });
</script>
</body>
</html>
